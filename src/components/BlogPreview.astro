---
import { getCollection, type CollectionEntry } from 'astro:content';
import { withBase } from '../utils/url';
// Load non-draft entries so we can showcase the three most recent posts on the homepage.
const all = (await getCollection('blog')) as CollectionEntry<'blog'>[];
const posts = all
  .filter((p) => !p.data.draft)
  .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate))
  .slice(0, 3)
  .map((entry) => {
    // Mirror the detail page reading time estimate (~200 wpm) for consistency.
    const words = entry.body?.split(/\s+/).filter(Boolean).length ?? 0;
    const readingTime = Math.max(1, Math.round(words / 200));
    return { entry, readingTime };
  });
---

<section id="blog" class="site-container site-section">
  <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-3 sm:gap-4">
    <div>
      <h2 class="text-3xl font-bold">From the blog</h2>
      <p class="mt-2 opacity-80">Thoughts on engineering, performance, and developer experience.</p>
    </div>
    <div class="mt-3 sm:mt-0">
      <a href={withBase('blog')} class="btn btn-ghost w-full sm:w-auto">View all</a>
    </div>
  </div>

  <div class="mt-8 grid gap-6 sm:grid-cols-2 md:grid-cols-3">
    {posts.map(({ entry, readingTime }) => {
      const href = withBase(`blog/${entry.slug}`);
      return (
  <a href={href} class="card bg-base-200 hover:bg-base-300 transition-colors">
          <div class="card-body">
            <h3 class="card-title">{entry.data.title}</h3>
            <p class="text-sm opacity-60 flex gap-2 items-center flex-wrap">
              <time datetime={new Date(entry.data.pubDate).toISOString()}>
                {new Date(entry.data.pubDate).toLocaleDateString()}
              </time>
              <span aria-hidden="true">â€¢</span>
              <span aria-label="Estimated reading time">{readingTime} min read</span>
            </p>
            {entry.data.description && <p class="opacity-80">{entry.data.description}</p>}
          </div>
        </a>
      );
    })}
  </div>
</section>
